cmake_minimum_required(VERSION 3.0)
project(NBOS)

set(CMAKE_ASM_NASM_OBJECT_FORMAT bin)

set(SRC_KANSIO "${CMAKE_SOURCE_DIR}/src")
set(BUILD_KANSIO "${CMAKE_BINARY_DIR}/build")

file(MAKE_DIRECTORY ${BUILD_KANSIO})

add_custom_target(floppy_image DEPENDS ${BUILD_KANSIO}/main_floppy.img)
add_dependencies(floppy_image bootloader kernel)

add_custom_command(
    OUTPUT ${BUILD_KANSIO}/main_floppy.img
    COMMAND dd if=/dev/zero of=${BUILD_KANSIO}/main_floppy.img bs=512 count=2880
    COMMAND mkfs.fat -F 12 -n "NBOS" ${BUILD_KANSIO}/main_floppy.img
    COMMAND dd if=${BUILD_KANSIO}/bootloader.bin of=${BUILD_KANSIO}/main_floppy.img conv=notrunc
    COMMAND mcopy -i ${BUILD_KANSIO}/main_floppy.img ${BUILD_KANSIO}/kernel.bin "::kernel.bin"
    DEPENDS bootloader kernel
)

add_custom_target(bootloader DEPENDS ${BUILD_KANSIO}/bootloader.bin)
add_custom_command(
    OUTPUT ${BUILD_KANSIO}/bootloader.bin
    COMMAND ${CMAKE_ASM_NASM_COMPILER} ${SRC_KANSIO}/bootloader/boot.asm -f bin -o ${BUILD_KANSIO}/bootloader.bin
    DEPENDS always
)

add_custom_target(kernel DEPENDS ${BUILD_KANSIO}/kernel.bin)
add_custom_command(
    OUTPUT ${BUILD_KANSIO}/kernel.bin
    COMMAND ${CMAKE_ASM_NASM_COMPILER} ${SRC_KANSIO}/kernel/main.asm -f bin -o ${BUILD_KANSIO}/kernel.bin
    DEPENDS always
)

add_custom_target(always COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_KANSIO})

add_custom_target(clean
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${BUILD_KANSIO}
    DEPENDS always
)
